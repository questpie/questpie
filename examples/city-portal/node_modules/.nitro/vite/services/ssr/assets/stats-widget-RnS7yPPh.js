import { jsx } from "react/jsx-runtime";
import { useMemo } from "react";
import { f as useResolveText, g as useCollectionCount, W as WidgetCard } from "./admin-NRknLhg2.js";
import { u as useServerWidgetData } from "./use-server-widget-data-C3Mqkn8Z.js";
import { f as formatCollectionName, c as cn } from "./utils-P1tbtlFB.js";
import { S as StatsWidgetSkeleton } from "./widget-skeletons-i0KIuI2-.js";
import "@base-ui/react/merge-props";
import "@base-ui/react/use-render";
import "@iconify/react";
import "class-variance-authority";
import "@base-ui/react/separator";
import "sonner";
import "@tanstack/react-query";
import "./router-DfekICpe.js";
import "@tanstack/react-router";
import "node:crypto";
import "node:async_hooks";
import "drizzle-orm";
import "drizzle-orm/pg-core";
import "zod";
import "node:os";
import "node:path";
import "../index.js";
import "@tanstack/react-router/ssr/server";
import "bun";
import "drizzle-orm/bun-sql";
import "drizzle-orm/pglite";
import "buffer";
import "path/posix";
import "path";
import "node:util";
import "crypto";
import "fs";
import "fs/promises";
import "url";
import "util";
import "assert";
import "drizzle-orm/casing";
import "node:fs";
import "node:events";
import "node:diagnostics_channel";
import "events";
import "worker_threads";
import "module";
import "prettier/plugins/html";
import "prettier/standalone";
import "node:stream";
import "http";
import "https";
import "zlib";
import "stream";
import "net";
import "dns";
import "os";
import "tls";
import "child_process";
import "node:assert";
import "node:timers/promises";
import "string_decoder";
import "@base-ui/react/button";
import "@base-ui/react/dialog";
import "@base-ui/react/accordion";
import "@base-ui/react/tabs";
import "@base-ui/react/checkbox";
import "@base-ui/react/switch";
import "@base-ui/react/menu";
import "date-fns";
import "@base-ui/react/popover";
import "date-fns/locale";
import "@base-ui/react/input";
import "react-dom";
import "@base-ui/react/select";
import "@base-ui/react/tooltip";
import "clsx";
import "tailwind-merge";
function getDateRange(preset) {
  const now = /* @__PURE__ */ new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  switch (preset) {
    case "today":
      return {
        gte: today,
        lte: new Date(today.getTime() + 24 * 60 * 60 * 1e3 - 1)
      };
    case "yesterday": {
      const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1e3);
      return {
        gte: yesterday,
        lte: new Date(today.getTime() - 1)
      };
    }
    case "thisWeek": {
      const dayOfWeek = today.getDay();
      const monday = new Date(
        today.getTime() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1) * 24 * 60 * 60 * 1e3
      );
      return {
        gte: monday,
        lte: now
      };
    }
    case "lastWeek": {
      const dayOfWeek = today.getDay();
      const thisMonday = new Date(
        today.getTime() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1) * 24 * 60 * 60 * 1e3
      );
      const lastMonday = new Date(
        thisMonday.getTime() - 7 * 24 * 60 * 60 * 1e3
      );
      return {
        gte: lastMonday,
        lte: new Date(thisMonday.getTime() - 1)
      };
    }
    case "thisMonth":
      return {
        gte: new Date(now.getFullYear(), now.getMonth(), 1),
        lte: now
      };
    case "lastMonth": {
      const firstOfThisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      return {
        gte: new Date(now.getFullYear(), now.getMonth() - 1, 1),
        lte: new Date(firstOfThisMonth.getTime() - 1)
      };
    }
    case "last7days":
      return {
        gte: new Date(now.getTime() - 7 * 24 * 60 * 60 * 1e3),
        lte: now
      };
    case "last30days":
      return {
        gte: new Date(now.getTime() - 30 * 24 * 60 * 60 * 1e3),
        lte: now
      };
    case "last90days":
      return {
        gte: new Date(now.getTime() - 90 * 24 * 60 * 60 * 1e3),
        lte: now
      };
    case "thisYear":
      return {
        gte: new Date(now.getFullYear(), 0, 1),
        lte: now
      };
    case "lastYear":
      return {
        gte: new Date(now.getFullYear() - 1, 0, 1),
        lte: new Date(now.getFullYear() - 1, 11, 31, 23, 59, 59)
      };
    default:
      return { gte: today, lte: now };
  }
}
const variantStyles = {
  default: "",
  primary: "border-primary/30 bg-primary/5",
  success: "border-success/30 bg-success/5",
  warning: "border-warning/30 bg-warning/5",
  danger: "border-destructive/30 bg-destructive/5"
};
const variantValueStyles = {
  default: "",
  primary: "text-primary",
  success: "text-success",
  warning: "text-warning",
  danger: "text-destructive"
};
function StatsWidget({ config }) {
  const resolveText = useResolveText();
  const {
    collection,
    label,
    filter,
    filterFn,
    dateFilter,
    icon: Icon,
    variant = "default",
    realtime,
    hasFetchFn,
    refreshInterval
  } = config;
  const serverQuery = useServerWidgetData(config.id, {
    enabled: !!hasFetchFn,
    refreshInterval
  });
  const computedFilter = useMemo(() => {
    let result = {};
    if (filter) {
      result = { ...result, ...filter };
    }
    if (filterFn) {
      result = { ...result, ...filterFn() };
    }
    if (dateFilter) {
      const { gte, lte } = getDateRange(dateFilter.range);
      result[dateFilter.field] = {
        gte: gte.toISOString(),
        lte: lte.toISOString()
      };
    }
    return Object.keys(result).length > 0 ? result : void 0;
  }, [filter, filterFn, dateFilter]);
  const collectionQuery = useCollectionCount(
    collection,
    computedFilter ? { where: computedFilter } : void 0,
    void 0,
    { realtime }
  );
  const {
    data: rawData,
    isLoading,
    error,
    refetch
  } = hasFetchFn ? serverQuery : collectionQuery;
  const count = hasFetchFn ? rawData?.count ?? 0 : rawData ?? 0;
  const displayLabel = label ? resolveText(label) : formatCollectionName(collection);
  return /* @__PURE__ */ jsx(
    WidgetCard,
    {
      title: displayLabel,
      icon: Icon,
      isLoading,
      loadingSkeleton: /* @__PURE__ */ jsx(StatsWidgetSkeleton, {}),
      error: error instanceof Error ? error : error ? new Error(String(error)) : null,
      onRefresh: () => refetch(),
      className: variantStyles[variant],
      children: /* @__PURE__ */ jsx("div", { className: cn("text-2xl font-bold", variantValueStyles[variant]), children: count.toLocaleString() })
    }
  );
}
export {
  StatsWidget as default
};
