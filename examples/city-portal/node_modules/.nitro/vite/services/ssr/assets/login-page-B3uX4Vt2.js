import { jsxs, jsx, Fragment } from "react/jsx-runtime";
import * as React from "react";
import { u as useAdminStore, i as selectClient, v as useTranslation, l as useForm, F as FieldGroup, m as Field, n as FieldLabel, o as FieldContent, I as Input, p as FieldError, B as Button, q as useAuthClient, e as selectNavigate, s as selectBasePath, t as selectBrandName } from "./admin-NRknLhg2.js";
import { useQuery } from "@tanstack/react-query";
import { A as Alert, a as AlertDescription, b as AuthLayout } from "./alert-DSUNWvis.js";
import { Icon } from "@iconify/react";
import { c as cn } from "./utils-P1tbtlFB.js";
import "@base-ui/react/merge-props";
import "@base-ui/react/use-render";
import "class-variance-authority";
import "@base-ui/react/separator";
import "sonner";
import "./router-DfekICpe.js";
import "@tanstack/react-router";
import "node:crypto";
import "node:async_hooks";
import "drizzle-orm";
import "drizzle-orm/pg-core";
import "zod";
import "node:os";
import "node:path";
import "../index.js";
import "@tanstack/react-router/ssr/server";
import "bun";
import "drizzle-orm/bun-sql";
import "drizzle-orm/pglite";
import "buffer";
import "path/posix";
import "path";
import "node:util";
import "crypto";
import "fs";
import "fs/promises";
import "url";
import "util";
import "assert";
import "drizzle-orm/casing";
import "node:fs";
import "node:events";
import "node:diagnostics_channel";
import "events";
import "worker_threads";
import "module";
import "prettier/plugins/html";
import "prettier/standalone";
import "node:stream";
import "http";
import "https";
import "zlib";
import "stream";
import "net";
import "dns";
import "os";
import "tls";
import "child_process";
import "node:assert";
import "node:timers/promises";
import "string_decoder";
import "@base-ui/react/button";
import "@base-ui/react/dialog";
import "@base-ui/react/accordion";
import "@base-ui/react/tabs";
import "@base-ui/react/checkbox";
import "@base-ui/react/switch";
import "@base-ui/react/menu";
import "date-fns";
import "@base-ui/react/popover";
import "date-fns/locale";
import "@base-ui/react/input";
import "react-dom";
import "@base-ui/react/select";
import "@base-ui/react/tooltip";
import "clsx";
import "tailwind-merge";
function useSetupStatus() {
  const client = useAdminStore(selectClient);
  return useQuery({
    queryKey: ["questpie", "setup-status"],
    queryFn: async () => {
      try {
        const result = await client.rpc.isSetupRequired({});
        return { required: result.required };
      } catch {
        return { required: false };
      }
    },
    staleTime: 1e3 * 60,
    // Cache for 1 minute
    retry: false
  });
}
function LoginForm({
  onSubmit,
  onSignUpClick,
  onForgotPasswordClick,
  showRememberMe = false,
  showSignUp = true,
  showForgotPassword = true,
  defaultValues,
  className,
  error,
  minPasswordLength = 8
}) {
  const { t } = useTranslation();
  const {
    register,
    handleSubmit,
    formState: { errors, isSubmitting }
  } = useForm({
    defaultValues: {
      email: "",
      password: "",
      rememberMe: false,
      ...defaultValues
    }
  });
  const handleFormSubmit = handleSubmit(async (values) => {
    await onSubmit(values);
  });
  return /* @__PURE__ */ jsxs("form", { onSubmit: handleFormSubmit, className: cn("space-y-4", className), children: [
    /* @__PURE__ */ jsxs(FieldGroup, { children: [
      /* @__PURE__ */ jsxs(Field, { "data-invalid": !!errors.email, children: [
        /* @__PURE__ */ jsx(FieldLabel, { htmlFor: "email", children: t("auth.email") }),
        /* @__PURE__ */ jsxs(FieldContent, { children: [
          /* @__PURE__ */ jsxs("div", { className: "relative", children: [
            /* @__PURE__ */ jsx(
              Icon,
              {
                icon: "ph:envelope-duotone",
                className: "text-muted-foreground absolute left-2 top-1/2 size-4 -translate-y-1/2"
              }
            ),
            /* @__PURE__ */ jsx(
              Input,
              {
                id: "email",
                type: "email",
                placeholder: t("auth.emailPlaceholder"),
                className: "pl-8",
                autoComplete: "email",
                "aria-invalid": !!errors.email,
                ...register("email", {
                  required: t("auth.emailRequired"),
                  pattern: {
                    value: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
                    message: t("auth.invalidEmail")
                  }
                })
              }
            )
          ] }),
          /* @__PURE__ */ jsx(FieldError, { children: errors.email?.message })
        ] })
      ] }),
      /* @__PURE__ */ jsxs(Field, { "data-invalid": !!errors.password, children: [
        /* @__PURE__ */ jsx(FieldLabel, { htmlFor: "password", children: t("auth.password") }),
        /* @__PURE__ */ jsxs(FieldContent, { children: [
          /* @__PURE__ */ jsxs("div", { className: "relative", children: [
            /* @__PURE__ */ jsx(
              Icon,
              {
                icon: "ph:lock-duotone",
                className: "text-muted-foreground absolute left-2 top-1/2 size-4 -translate-y-1/2"
              }
            ),
            /* @__PURE__ */ jsx(
              Input,
              {
                id: "password",
                type: "password",
                placeholder: t("auth.passwordPlaceholder"),
                className: "pl-8",
                autoComplete: "current-password",
                "aria-invalid": !!errors.password,
                ...register("password", {
                  required: t("auth.passwordRequired"),
                  minLength: {
                    value: minPasswordLength,
                    message: t("auth.passwordMinLength", {
                      min: minPasswordLength
                    })
                  }
                })
              }
            )
          ] }),
          /* @__PURE__ */ jsx(FieldError, { children: errors.password?.message })
        ] })
      ] }),
      (showRememberMe || showForgotPassword) && /* @__PURE__ */ jsxs("div", { className: "flex items-center justify-between", children: [
        showRememberMe && /* @__PURE__ */ jsxs("label", { className: "text-muted-foreground flex items-center gap-2 text-xs", children: [
          /* @__PURE__ */ jsx(
            "input",
            {
              type: "checkbox",
              className: "rounded border-gray-300",
              ...register("rememberMe")
            }
          ),
          t("auth.rememberMe")
        ] }),
        showForgotPassword && /* @__PURE__ */ jsx(
          Button,
          {
            type: "button",
            variant: "link",
            size: "sm",
            onClick: onForgotPasswordClick,
            className: "h-auto p-0 text-xs",
            children: t("auth.forgotPassword")
          }
        )
      ] })
    ] }),
    error && /* @__PURE__ */ jsxs(Alert, { variant: "destructive", children: [
      /* @__PURE__ */ jsx(Icon, { icon: "ph:warning-circle" }),
      /* @__PURE__ */ jsx(AlertDescription, { children: error })
    ] }),
    /* @__PURE__ */ jsx(
      Button,
      {
        type: "submit",
        className: "w-full",
        size: "lg",
        disabled: isSubmitting,
        children: isSubmitting ? /* @__PURE__ */ jsxs(Fragment, { children: [
          /* @__PURE__ */ jsx(Icon, { icon: "ph:spinner-gap-bold", className: "animate-spin" }),
          t("auth.signingIn")
        ] }) : t("auth.signIn")
      }
    ),
    showSignUp && /* @__PURE__ */ jsxs("p", { className: "text-muted-foreground text-center text-xs", children: [
      t("auth.dontHaveAccount"),
      " ",
      /* @__PURE__ */ jsx(
        Button,
        {
          type: "button",
          variant: "link",
          size: "sm",
          onClick: onSignUpClick,
          className: "h-auto p-0 text-xs",
          children: t("auth.signUp")
        }
      )
    ] })
  ] });
}
function LoginPage({
  title = "Sign in",
  description = "Enter your credentials to access the admin panel",
  logo,
  redirectTo,
  forgotPasswordPath,
  signUpPath,
  showForgotPassword = true,
  showSignUp = false
}) {
  const authClient = useAuthClient();
  const navigate = useAdminStore(selectNavigate);
  const basePath = useAdminStore(selectBasePath);
  const brandName = useAdminStore(selectBrandName);
  const [error, setError] = React.useState(null);
  const { data: setupStatus, isLoading: isCheckingSetup } = useSetupStatus();
  React.useEffect(() => {
    if (!isCheckingSetup && setupStatus?.required) {
      navigate(`${basePath}/setup`);
    }
  }, [isCheckingSetup, setupStatus, navigate, basePath]);
  const handleSubmit = async (values) => {
    setError(null);
    try {
      const result = await authClient.signIn.email({
        email: values.email,
        password: values.password
      });
      if (result.error) {
        setError(result.error.message || "Invalid credentials");
        return;
      }
      navigate(redirectTo ?? basePath);
    } catch (err) {
      setError(err instanceof Error ? err.message : "An error occurred");
    }
  };
  const handleForgotPasswordClick = () => {
    navigate(forgotPasswordPath ?? `${basePath}/forgot-password`);
  };
  const handleSignUpClick = () => {
    if (signUpPath) {
      navigate(signUpPath);
    }
  };
  return /* @__PURE__ */ jsx(
    AuthLayout,
    {
      title,
      description,
      logo: logo ?? /* @__PURE__ */ jsx(DefaultLogo, { brandName }),
      children: /* @__PURE__ */ jsx(
        LoginForm,
        {
          onSubmit: handleSubmit,
          onForgotPasswordClick: handleForgotPasswordClick,
          onSignUpClick: handleSignUpClick,
          showForgotPassword,
          showSignUp,
          error
        }
      )
    }
  );
}
function DefaultLogo({ brandName }) {
  return /* @__PURE__ */ jsx("div", { className: "text-center", children: /* @__PURE__ */ jsx("h1", { className: "text-xl font-bold", children: brandName }) });
}
export {
  LoginPage,
  LoginPage as default
};
