import { jsx, jsxs, Fragment } from "react/jsx-runtime";
import { Icon } from "@iconify/react";
import { useQuery } from "@tanstack/react-query";
import { u as useAdminStore, f as useResolveText, r as resolveIconElement, W as WidgetCard, i as selectClient } from "./admin-NRknLhg2.js";
import { u as useServerWidgetData } from "./use-server-widget-data-C3Mqkn8Z.js";
import { c as cn } from "./utils-P1tbtlFB.js";
import { a as TimelineWidgetSkeleton } from "./widget-skeletons-i0KIuI2-.js";
import "react";
import "@base-ui/react/merge-props";
import "@base-ui/react/use-render";
import "class-variance-authority";
import "@base-ui/react/separator";
import "sonner";
import "./router-DfekICpe.js";
import "@tanstack/react-router";
import "node:crypto";
import "node:async_hooks";
import "drizzle-orm";
import "drizzle-orm/pg-core";
import "zod";
import "node:os";
import "node:path";
import "../index.js";
import "@tanstack/react-router/ssr/server";
import "bun";
import "drizzle-orm/bun-sql";
import "drizzle-orm/pglite";
import "buffer";
import "path/posix";
import "path";
import "node:util";
import "crypto";
import "fs";
import "fs/promises";
import "url";
import "util";
import "assert";
import "drizzle-orm/casing";
import "node:fs";
import "node:events";
import "node:diagnostics_channel";
import "events";
import "worker_threads";
import "module";
import "prettier/plugins/html";
import "prettier/standalone";
import "node:stream";
import "http";
import "https";
import "zlib";
import "stream";
import "net";
import "dns";
import "os";
import "tls";
import "child_process";
import "node:assert";
import "node:timers/promises";
import "string_decoder";
import "@base-ui/react/button";
import "@base-ui/react/dialog";
import "@base-ui/react/accordion";
import "@base-ui/react/tabs";
import "@base-ui/react/checkbox";
import "@base-ui/react/switch";
import "@base-ui/react/menu";
import "date-fns";
import "@base-ui/react/popover";
import "date-fns/locale";
import "@base-ui/react/input";
import "react-dom";
import "@base-ui/react/select";
import "@base-ui/react/tooltip";
import "clsx";
import "tailwind-merge";
const variantStyles = {
  default: "bg-muted-foreground",
  success: "bg-success",
  warning: "bg-warning",
  error: "bg-destructive",
  info: "bg-info"
};
function formatTimestamp(date, format = "relative") {
  const d = typeof date === "string" ? new Date(date) : date;
  switch (format) {
    case "absolute":
      return d.toLocaleDateString();
    case "datetime":
      return d.toLocaleString();
    case "relative":
    default: {
      const now = /* @__PURE__ */ new Date();
      const diff = now.getTime() - d.getTime();
      const seconds = Math.floor(diff / 1e3);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);
      if (days > 7) return d.toLocaleDateString();
      if (days > 0) return `${days}d ago`;
      if (hours > 0) return `${hours}h ago`;
      if (minutes > 0) return `${minutes}m ago`;
      return "just now";
    }
  }
}
function TimelineWidget({
  config,
  navigate
}) {
  const client = useAdminStore(selectClient);
  const resolveText = useResolveText();
  const {
    maxItems = 10,
    showTimestamps = true,
    timestampFormat = "relative",
    emptyMessage
  } = config;
  const useServerData = !!config.hasFetchFn;
  const serverQuery = useServerWidgetData(config.id, {
    enabled: useServerData,
    refreshInterval: config.refreshInterval
  });
  const clientQuery = useQuery({
    queryKey: ["widget", "timeline", config.id],
    queryFn: () => config.fetchFn(client),
    enabled: !useServerData && !!config.fetchFn,
    refetchInterval: config.refreshInterval
  });
  const { data, isLoading, error, refetch } = useServerData ? serverQuery : clientQuery;
  const items = data?.slice(0, maxItems) ?? [];
  const title = config.title ? resolveText(config.title) : void 0;
  const handleItemClick = (item) => {
    if (item.href && navigate) {
      navigate(item.href);
    }
  };
  const emptyContent = /* @__PURE__ */ jsx("div", { className: "flex h-24 items-center justify-center text-muted-foreground", children: /* @__PURE__ */ jsx("p", { className: "text-sm", children: emptyMessage ? resolveText(emptyMessage) : "No activity yet" }) });
  const timelineContent = items.length === 0 ? emptyContent : /* @__PURE__ */ jsx("div", { className: "space-y-0", children: items.map((item, index) => {
    const iconElement = resolveIconElement(item.icon, {
      className: "h-3 w-3 text-white"
    });
    const variant = item.variant || "default";
    const isLast = index === items.length - 1;
    const isClickable = !!(item.href && navigate);
    const itemContent = /* @__PURE__ */ jsxs(Fragment, { children: [
      !isLast && /* @__PURE__ */ jsx("div", { className: "absolute left-[11px] top-6 bottom-0 w-px bg-border" }),
      /* @__PURE__ */ jsx(
        "div",
        {
          className: cn(
            "relative z-10 flex h-6 w-6 shrink-0 items-center justify-center rounded-full",
            variantStyles[variant]
          ),
          children: iconElement ?? /* @__PURE__ */ jsx(
            Icon,
            {
              icon: "ph:circle-bold",
              className: "h-3 w-3 text-white"
            }
          )
        }
      ),
      /* @__PURE__ */ jsxs("div", { className: "flex-1 min-w-0 pt-0.5 text-left", children: [
        /* @__PURE__ */ jsx("p", { className: "text-sm font-medium truncate", children: item.title }),
        item.description && /* @__PURE__ */ jsx("p", { className: "text-xs text-muted-foreground mt-0.5 line-clamp-2", children: item.description }),
        showTimestamps && item.timestamp && /* @__PURE__ */ jsx("p", { className: "text-xs text-muted-foreground mt-1", children: formatTimestamp(item.timestamp, timestampFormat) })
      ] })
    ] });
    if (isClickable) {
      return /* @__PURE__ */ jsx(
        "button",
        {
          type: "button",
          className: cn(
            "relative flex gap-3 pb-4 w-full",
            "cursor-pointer hover:bg-muted/30 -mx-2 px-2 rounded-md transition-colors",
            isLast && "pb-0"
          ),
          onClick: () => handleItemClick(item),
          children: itemContent
        },
        item.id
      );
    }
    return /* @__PURE__ */ jsx(
      "div",
      {
        className: cn("relative flex gap-3 pb-4", isLast && "pb-0"),
        children: itemContent
      },
      item.id
    );
  }) });
  return /* @__PURE__ */ jsx(
    WidgetCard,
    {
      title,
      isLoading,
      loadingSkeleton: /* @__PURE__ */ jsx(TimelineWidgetSkeleton, { count: maxItems }),
      error: error instanceof Error ? error : error ? new Error(String(error)) : null,
      onRefresh: () => refetch(),
      children: timelineContent
    }
  );
}
export {
  TimelineWidget as default
};
